=============================================================================
Ultimate Soundtracker module format description
Version 0.1 (w) 1997 by Michael Schwendt <sidplay@geocities.com>
=============================================================================

This is  an attempt  on documenting  the file  format of music modules
(MOD  files)  that  were  created  with  Karsten  Obarski's   Ultimate
Soundtracker, the original  Soundtracker that started  it all back  in
1987/88 on AMIGA.

Whereas  various   Soundtracker  derivatives   such  as    Protracker,
Noisetracker,  or  a  few  of  the  Soundtracker v2 series, are widely
known and supported, hardly  any available MODule player  supports old
and classic Soundtracker modules.

In  1988  and  later  Karsten  Obarski's  original program was hacked,
ripped  off,  and  improved  by  various programmers from cracking and
demo groups.  Some of the  first were Exterminator of TJC, Tip  of The
New  Masters,  Unknown/D.O.C,  Mahoney  &  Kaktus  of  Northstar   and
Silents, and Mnemotron/Spreadpoint.  During this process the  original
module  format  got  altered  and  extended.   One  by-product of this
development   was    partial   incompatibility    between    competing
Soundtrackers and their modules,  most noticably between the  Ultimate
Soundtracker and  the first  illegal series  of Soundtracker versions.
Even  worse,  some  changes  made  it  impossible  -  or at least very
difficult - to detect the true module format.

Years later  people without  knowledge of  the incompatibility between
the  original   Soundtracker  module   format  and   successors   like
Soundtracker 2.4 or Protracker  damaged modules by converting  them to
Protracker  format.   It  would  be  tiresome  trying to find any such
module in any  collection and either  repair or remove  it in case  it
can't be restored properly.  However, the opposite doesn't seem to  be
a real choice either.  Rather than trying to find and convert any  old
Soundtracker module  into some  well-defined module  format, it sounds
much more reasonable  to add native  Ultimate Soundtracker support  to
MODule players.

Old Soundtracker modules  that are likely  to be found  in any classic
collection  are  those  composed  by  Karsten Obarski himself, such as
famous game sounds from  Amegas, Crystal Hammer, Ralleymaster  (sic!),
or Sarcophaser, to name a few, and others done in 1987 and 1988,  most
noticably the unforgotten tunes by SLL.

Rather  than  serving  as  a  complete  MOD  reference,  this document
focuses  on  relevant  differences  between  the Ultimate Soundtracker
format and the first  popular hacked Soundtracker versions  that still
featured  4  voices  and  15  channels.   The terminology used in this
document might differ from other available MOD format descriptions.

The following abbreviations are  local to this document.  Please don't
use them in MOD players. They are uncommon and would confuse users.

 UST -> Ultimate Soundtracker
 ST  -> Soundtracker (scene versions)
 MST -> Master Soundtracker
 PT  -> Protracker
 NT  -> Noisetracker

One false assumption often made is that "M.K." is an ID introduced  in
Protracker or by "Mahoney & Kaktus".  The truth is it was  Unknown/DOC
who put his initials into Soundtracker 2.4 to server as format ID  and
indicate 31 samples.  Mahoney & Kaktus used "N.T." in Noisetracker.

Thanks  to  Jake  Stine  (MikMod)  and  Lada Kopecky (A.M.P) for their
interesting discussions about UST format detection proposals.

If you have any comments or corrections, feel free to e-mail me.

-----------------------------------------------------------------------------

Short summary of differences and incompatibilities (more below):

 - maximum sample length
 - numbering of effects
 - playing of repeat-samples (looping samples)

Format characteristics:

 - 4 tracks (voices, channels)
 - 15 sample headers (instrument definitions, slots)
 - sample header length is 30 bytes
 - 128 pattern table steps (pattern order)
 - pattern length is 1024 bytes

File offset         Content description

 + 0                song/module working title
 + 20               15 sample headers (see below)
 + 470              song length (number of steps in pattern table)
 + 471              song speed in beats per minute (see below)
 + 472              pattern step table
 + 600              pattern data (1024 bytes) for each pattern number
 .                  that can be found in entire pattern table
 .
 + ???              sample data


Sample header (big-endian byte order):

 + 0  sample file/name
 + 22 sample length in words
 + 24 volume word (0-64)
 + 26 sample repeat offset in bytes
 + 28 sample repeat length in words (0=loop off, >1 loop on)
[+ 30 (end)]


Noticable features in sample header:

 - Volume word does not contain a "Finetuning" value in its high-byte.

 - Sample repeat offset is in bytes (unlike PT, NT, and ST 2.5, where
   it is specified as number of words).

 - Maximum sample length is 9999 bytes decimal, but 1387 words hexadecimal.
   Longest samples on original sample disk ST-01 were 9900 bytes.

 - Sample file names have no disk name prefix like "st-01:" or "ST-01:"
   since only a single sample disk was supported. In later ST versions
   one had to enter a disk name.

   Caveat: There are hacked modules where disk names have been
           dropped or added.

Notes on playing repeat-samples:

 - Unlike PT only the loop-area is played. PT plays from Start to Repeat
   End and then loops between Repeat Start and Repeat End. UST modules
   often (!) sound screwed if repeat-samples are played incorrectly.
   Hence: Sample Start = Repeat Start, Sample Length = Repeat Length.

Effects:

 - Arpeggio: 1xy (1. base note)
                 (2. x semitones higher)
                 (3. y semitones higher)

 - Pitchbend: 2xy (20y = sub y from period = pitch up)
                  (2x0 = add x to period = pitch down)

Conversion of UST effects to PT (or MST):

 - Arpeggio:  1xy => 0xy

 - Pitchbend: 20y => 10y
              2x0 => 20x

-----------------------------------------------------------------------------

Song speed in beats per minute:

The byte at module offset 471  is not the "song restart position".  It
is meant to be  the song speed in  beats per minute (bpm),  satisfying
this formula:

  AMIGA Timer-IRQ value = (240-bpm)*122

This might  be constant  for other  15-instrument ST  modules, but not
for the Ultimate Soundtracker.

The default for UST  modules is 0x78 =  120 BPM = 48  Hz. AMIGA custom
chips only ran at 716 kHz,  which is one tenth of the  processor clock
speed.  Thus:

  freq = 716 kHz / ((240-bpm)*122)
  [freq] = kHz

Rumours state  that Karsten  Obarski made  a failure  upon calculating
that default speed and planned to get a default of 50 Hz. For sure  he
didn't calculate  at full  precision.   This would  have required  the
true accurate clock speed of the  AMIGA.  And that one was  varying in
different documentation.  If you happen to find a more accurate  clock
speed, the result might differ by 1-2 Hz more. Look:

  with 716 kHz = 716*1024 Hz : freq(120) ~= 50.08 Hz
  with 716 kHz = 716*1000 Hz : freq(120) ~= 48.9 Hz

-----------------------------------------------------------------------------

An experimental format detection:

Note that the recommended way is  to either default to UST or  provide
a switch to  toggle between UST  and ST. The  fact that an  UST module
can't  be  detected  100%  percent  correctly,  can't  make  MODplayer
authors happy. But think about a switch at least.

 - Check whether every Sample Length is <= 9999 bytes. If not, the
   MOD cannot be in UST format. Newer Sountrackers supported samples
   longer than 9999 bytes. So, it might be in some newer ST format.

   Caveat: It still could be a ST, MST or PT module with short samples.

 - If (Repeat Offset in words + Repeat Length in words) converted to
   bytes exceeds Sample End and/or length of file, it is an UST file
   with Repeat Offset in bytes. In other words, first assume Repeat
   Offset to be given in words and calculate the Repeat End in order
   to be able to check the sample range:

     Sample Start + Repeat Offset * 2 = Repeat End

   If this Repeat End exceeds the sample end, it is an UST module and
   Repeat Offset is specified in bytes.

   Caveat: The looping in some ST modules (bad rips, for instance)
   could go a couple of bytes past the end, so better add some safety
   bytes.

 - If you use a format loader/converter, scan each pattern for the
   availability of PT effects or any effects other than 1xy and 2xy.
   If available it cannot be UST.

   Might be an idea to check the pattern data for effects 1xy and 2xy
   with xy > 0x1f. Could be that no Soundtracker module would ever have
   a reason to pitchbend up or down that far, while almost any UST module
   that uses either effect does so. The exception would be a UST module
   that uses only 20y / 21x commands or a very low arpeggio.

Of  course,  the  only  exception  to  the  rule  now  is  if  a newer
SoundTracker module doesn't  follow the sample  prefix rules, has  all
samples < 9999 bytes, uses no effects at all, and has a loop near  the
start of a sample only. A more advanced detection could check  whether
the samples are from the ST-01 sample disk preset.

Master  Soundtracker  1.0  introduced  new  effects and changes effect
numbering.

Soundtracker 2.0  was based  on Master  Soundtracker 1.0. Soundtracker
2.0, 2.1, 2.2, 2.3, 2.4 have Repeat Offset specified in bytes.  As  of
Soundtracker  2.5  Repeat  Offset  is  in  words.   Soundtracker   2.3
introduced  31  samples.   Soundtracker  2.4  introduced Unknown/DOC's
initials  "M.K."  as   format  ID.  Soundtracker   2.6  introduced   a
double-sized  pattern  order  table  and  the  "MTN"  format  ID  from
Mnemotron.

In  Noisetracker   1.0,  Repeat   Offset  is   specified  in    words.
Noisetracker features 31 samples and the "N.T." ID.

-----------------------------------------------------------------------------

/*
Arpeggio
Where [0][x][y] means "play note, note+x semitones, note+y semitones,
then return to original note".
The fluctuations are carried out evenly spaced in one pattern division.
They are usually used to simulate chords, but this doesn't work too well.
They are also used to produce heavy vibrato.
A major chord is when x=4, y=7.  A minor chord is when x=3, y=7.

Slide up
Where [1][x][y] means "smoothly decrease the period of current sample
by x*16+y after each tick in the division".
The ticks/division are set with the 'set speed' effect (see below).
If the period of the note being played is z, then the final period will be
z - (x*16 + y)*(ticks - 1).
As the slide rate depends on the speed,
changing the speed will change the slide.
You cannot slide beyond the note B3 (period 113).

Vibrato + Volume Slide
Continue 'Vibrato', but also do Volume slide.
Where [6][x][y] means "either slide the volume up x*(ticks - 1) or
slide the volume down y*(ticks - 1), at the same time as continuing the last
'Vibrato'". It is illegal for both x and y to be non-zero.
You cannot slide outside the volume range 0..64.

Slide to note + Volume Slide
Continue 'Slide to note', but also do Volume slide.
Where [5][x][y] means "either slide the volume up x*(ticks - 1) or
slide the volume down y*(ticks - 1), at the same time as continuing the
last 'Slide to note'".
It is illegal for both x and y to be non-zero.
You cannot slide outside the volume range 0..64.
The period-length in this channel's division is a parameter to this effect,
and hence is not played.

Vibrato
Where [4][x][y] means "oscillate the sample pitch using a particular
waveform with amplitude y/16 semitones, such that (x * ticks)/64
cycles occur in the division".
The waveform is set using effect [14][4].
By placing vibrato effects on consecutive divisions, the vibrato effect
can be maintained.
If either x or y are 0, then the old vibrato values will be used.

Slide to note
Where [3][x][y] means "smoothly change the period of current sample by
x*16+y after each tick in the division, never sliding beyond current period".
The period-length in this channel's division is a parameter to this effect,
and hence is not played.
Sliding to a note is similar to effects [1] and [2],
but the slide will not go beyond the given period, and the
direction is implied by that period.
If x and y are both 0, then the old slide will continue.

Slide Down
Where [2][x][y] means "smoothly increase the period of current sample by
x*16+y after each tick in the division".
Similar to [1], but lowers the pitch.
You cannot slide beyond the note C1 (period 856).

Tremolo
Where [7][x][y] means "oscillate the sample volume using a particular waveform
with amplitude y*(ticks - 1), such that (x * ticks)/64 cycles occur in
the division".
The waveform is set using effect [14][7]. Similar to [4].

Set Panning
Where [C][x][y] means "set current sample's panning to x*16+y".
Legal values are 0..FF. Midle : 80, Left : 00, Right : FF

Set speed
Where [F][x][y] means "set speed to x*16+y".
Though it is nowhere near that simple.
Let z = x*16+y.
Depending on what values z takes, different units of speed are set,
there being two: ticks/division and beats/minute.
If z<=32, then it means "set ticks/division to z"
otherwise it means "set beats/minute to z".
Default values are 6 ticks/division, and 125 beats/minute.

Pattern Break
Where [D][x][y] means "stop the pattern after this division, and
continue the song at the next pattern at division x*10+y"
(the 10 is not a typo).  Legal divisions are from 0 to 63
(note Protracker exception above).

Set volume
Where [C][x][y] means "set current sample's volume to x*16+y".
Legal volumes are 0..64.

Volume slide
Where [A][x][y] means "either slide the volume up x*(ticks - 1) or
slide the volume down y*(ticks - 1)".
If both x and y are non-zero, then the y value is ignored (assumed to be 0).
You cannot slide outside the volume range 0..64.

Set sample offset
Where [9][x][y] means "play the sample from offset x*4096 + y*256".
The offset is measured in words. If no sample is given, yet one is still
playing on this channel, it should be retriggered to the new offset
using the current volume.

Invert loop
Where [E][F][x] mean s "if x is greater than 0, then play the current sample's
loop upside down at speed x".
Each byte in the sample's loop will have its sign changed (negated).
It will only work if the sample's loop (defined previously) is not too big.
The speed is based on an internal table.

Delay pattern
Where [E][E][x] means "after this division there will be a delay equivalent to
the time taken to play x divisions after which the pattern will be resumed".
The delay only relates to the interpreting of new divisions, and all effects
and previous notes continue during delay.

Delay sample
Where [E][D][x] means "do not start this division's sample for the first x
ticks in this division, play the sample after this".
This implies that if x is 0, then you will hear no delay, but actually there
will be a VERY small delay.
Note that this effect only influences a sample if it was started in this
division.

Cut sample
Where [E][C][x] means "after the current sample has been played for x ticks in
this division, its volume will be set to 0".
This implies that if x is 0, then you will not hear any of the sample.
If you wish to insert "silence" in a pattern, it is better to use a
"silence"-sample (see above) due to the lack of proper support for this effect.

Fine volume slide down
Where [E][B][x] means "decrement the volume of the current sample by x".
Similar to [14][10] but lowers volume.
You cannot slide beyond volume 0.

Fine volume slide up
Where [E][A][x] means "increment the volume of the current sample by x".
The incrementing takes place at the beginning of the division, and
hence there is no sliding.
You cannot slide beyond volume 64.

Retrigger sample
Where [E][9][x] means "trigger current sample every x ticks in this division".
If x is 0, then no retriggering is done (acts as if no effect was chosen),
otherwise the retriggering begins on the first tick and then x ticks
after that, etc.

Set tremolo waveform
Where [E][7][x] means "set the waveform of succeeding 'tremolo' effects to
wave #x".
Similar to [14][4], but alters effect [7] - the 'tremolo' effect.

Loop pattern
Where [E][6][x] means "set the start of a loop to this division if x is 0,
otherwise after this division, jump back to the start of a loop and play
it another x times before continuing".
If the start of the loop was not set, it will default to the start of the
current pattern.
Hence 'loop pattern' cannot be performed across multiple patterns.
Note that loops do not support nesting, and you may generate an infinite
loop if you try to nest 'loop pattern's.

Set finetune value
Where [E][5][x] means "sets the finetune value of the current sample to the
signed nibble x".
x has legal values of 0..15, corresponding to signed nibbles 0.
.7,-8..-1 (see start of text for more info on finetune values).

Set vibrato waveform
Where [E][4][x] means "set the waveform of succeeding 'vibrato' effects to
wave #x".
[4] is the 'vibrato' effect.
Possible values for x are: 0 - sine (default) 4  (without retrigger) 1 -
ramp down 5  (without retrigger) 2 - square 6  (without retrigger) 3 - random:
a random choice of one of the above. 7  (without retrigger).
If the waveform is selected "without retrigger", then it will not be
retriggered from the beginning at the start of each new note.

Set glissando on/off
Where [E][3][x] means "set glissando ON if x is 1, OFF if x is 0".
Used in conjunction with [3] ('Slide to note').
If glissando is on, then 'Slide to note' will slide in semitones,
otherwise will perform the default smooth slide.

Fineslide down
Where [E][2][x] means "increment the period of the current sample by x".
Similar to [14][1] but shifts the pitch down.
You cannot slide beyond the note C1 (period 856).

Fineslide up
Where [E][1][x] means "decrement the period of the current sample by x".
The incrementing takes place at the beginning of the division, and hence
there is no actual sliding.
You cannot slide beyond the note B3 (period 113).

Set filter on/off
Where [E][0][x] means "set sound filter ON if x is 0, and OFF is x is 1".
This is a hardware command for some Amigas, so if you don't understand it,
it is better not to use it.

Position Jump
Where [B][x][y] means "stop the pattern after this division, and continue the
song at song-position x*16+y".
This shifts the 'pattern-cursor' in the pattern table (see above).
Legal values for x*16+y are from 0 to 127.
See Partition Window : the argument is pos ID -1.

Note OFF
Where [G][x][y] means that you do a Key OFF on last instrument used with this
track.
If [x][y] is equal to 0, it means stop immediately the previous instrument.
If [x][y] is equal to 1, it means generate a Note-Off on the previous
instrument.
This effect is only usefull in the Multi-Channel Tracks mode.
If Multi-Channel Tracks is not active, this effect has no effect.

*/
